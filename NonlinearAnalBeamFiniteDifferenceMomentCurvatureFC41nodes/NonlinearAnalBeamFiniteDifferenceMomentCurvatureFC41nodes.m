%***********************************************************%
%               >> IN THE NAME OF ALLAH <<                  %
% Analysis of Fixed Beam with distributed load              %
% By Finite difference Method. - Force control              %                                                 
%-----------------------------------------------------------%
%    This program is written by salar delavar ghashghaei    %
%           E-mail: salar.d.ghashghaei@gmail.com            %
%-----------------------------------------------------------%
%                             W                             %
%                    ||||||||||||||||||||                   %
%           fixed  ||--------------------||                 %
%                   |<-    L,EI(Phi)   ->|                  %
%***********************************************************%
clc;clear all;close all;
% Define Parameters in mm,kN
W= -5*10^-6; % [kN/mm] % Shear load Value (+ : Up)
L = 6000; % [mm] % beam length
m = 10000; % number of calculation (Load Steps)
Dmax=500; % [mm] Max. Displacement
itermax = 18000;% maximum number of iterations
tolerance = 1e-6; % specified tolerance for convergence
u = zeros(41,1);% initial guess value
%zon= zeros(41,1)+1;% initial guess value
%%% monitor cpu time
starttime = cputime;
%% Moment-Curvature of Beam
% Phi-Y : Yeild Curvature [1/mm]
% My : Yeild Moment       [kN.mm]
% Phi-U : Ultimate Curvature [1/mm]
% Mu : Ultimate Moment    [kN.mm]   
%       Phi-Y     My      Phi-U     Mu 
%===========================================
%      [1/mm]   [kN.mm]  [1/mm]   [kN.mm]
da = [.000102 16.1e+3 .001366 20.1e+3; % section(1)
      .000102 16.1e+3 .001366 20.1e+3; % section(2)
      .000102 16.1e+3 .001366 20.1e+3; % section(3)
      .000102 16.1e+3 .001366 20.1e+3; % section(4)
      .000102 16.1e+3 .001366 20.1e+3; % section(5)
      .000102 16.1e+3 .001366 20.1e+3; % section(6)
      .000102 16.1e+3 .001366 20.1e+3; % section(7)
      .000102 16.1e+3 .001366 20.1e+3; % section(8)
      .000102 16.1e+3 .001366 20.1e+3; % section(9)
      .000102 16.1e+3 .001366 20.1e+3; % section(10)
      .000102 16.1e+3 .001366 20.1e+3; % section(11)
      .000102 16.1e+3 .001366 20.1e+3; % section(12)
      .000102 16.1e+3 .001366 20.1e+3; % section(13)
      .000102 16.1e+3 .001366 20.1e+3; % section(14)
      .000102 16.1e+3 .001366 20.1e+3; % section(15)
      .000102 16.1e+3 .001366 20.1e+3; % section(16)
      .000102 16.1e+3 .001366 20.1e+3; % section(17)
      .000102 16.1e+3 .001366 20.1e+3; % section(18)
      .000102 16.1e+3 .001366 20.1e+3; % section(19)
      .000102 16.1e+3 .001366 20.1e+3; % section(20)
      .000102 16.1e+3 .001366 20.1e+3; % section(21)
      .000102 16.1e+3 .001366 20.1e+3; % section(22)
      .000102 16.1e+3 .001366 20.1e+3; % section(23)
      .000102 16.1e+3 .001366 20.1e+3; % section(24)
      .000102 16.1e+3 .001366 20.1e+3; % section(25)
      .000102 16.1e+3 .001366 20.1e+3; % section(26)
      .000102 16.1e+3 .001366 20.1e+3; % section(27)
      .000102 16.1e+3 .001366 20.1e+3; % section(28)
      .000102 16.1e+3 .001366 20.1e+3; % section(29)
      .000102 16.1e+3 .001366 20.1e+3; % section(30)
      .000102 16.1e+3 .001366 20.1e+3; % section(31)
      .000102 16.1e+3 .001366 20.1e+3; % section(32)
      .000102 16.1e+3 .001366 20.1e+3; % section(33)
      .000102 16.1e+3 .001366 20.1e+3; % section(34)
      .000102 16.1e+3 .001366 20.1e+3; % section(35)
      .000102 16.1e+3 .001366 20.1e+3; % section(36)
      .000102 16.1e+3 .001366 20.1e+3; % section(37)
      .000102 16.1e+3 .001366 20.1e+3; % section(38)
      .000102 16.1e+3 .001366 20.1e+3; % section(39)
      .000102 16.1e+3 .001366 20.1e+3; % section(40)
      .000102 16.1e+3 .001366 20.1e+3]; % section(41)
%% FINITE-DIFFERENCE METHOD
    for i=1:1:41;
    EIe(i)=da(i,2)/da(i,1); % Elastic Flextural Rigidity
    %EIp(i)=(da(i,4)-da(i,2))/(da(i,3)-da(i,1));% Plastic Flextural Rigidity
    EIp(i)=(da(i,4))/(da(i,3));% Plastic Flextural Rigidity
    end
 landa=L/42;for i=1:1:43;X(i)=(i-1)*landa;end
 Q=0.5*W*landa;
for I=1:m
  z = [-2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(1)
       1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(2)
       0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(3)
       0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(4)
       0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(5)
       0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(6)
       0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(7)
       0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(8)
       0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(9)
       0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(10)
       0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(11)
       0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(12)
       0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(13)
       0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(14)
       0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(15)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(16)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(17)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(18)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(19)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(20)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(21)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(22)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(23)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(24)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(25)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(26)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(27)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0; % section(28)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0; % section(29)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0; % section(30)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0; % section(31)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0; % section(32)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0; % section(33)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0; % section(34)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0; % section(35)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0; % section(36)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0; % section(37)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0; % section(38)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0; % section(39)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1; % section(40)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2]; % section(41)
   fi = (z/landa^2)*u; % Curvature of each section
   for i=1:41;
     if and(abs(fi(i)) >=0,abs(fi(i)) <=da(i,1));
         EI(i) = EIe(i);
     elseif and(abs(fi(i)) >da(i,1),abs(fi(i)) <=da(i,3));
         EI(i) =(da(i,2) +(abs(fi(i))-da(i,1))*EIp(i))/abs(fi(i));
     end
     a(i)=EI(i)/(landa^4);
   end
   % Finite-difference coefficients
   A(1)=2*6*a(1);B(1)=-4*a(1);C(1)=a(1);A(41)=2*6*a(41);B(41)=-4*a(41);C(41)=a(41);
   for j=2:1:40;A(j)=6*a(j);B(j)=-4*a(j);C(j)=a(j);end
       
% Equivalent stiffness Matrix
%1      1 2 3 4 5 6 7 8 9 10
k01_10=[A(1) B(1) C(1) 0 0 0 0 0 0 0];
k01_20=[0 0 0 0 0 0 0 0 0 0];
k01_30=[0 0 0 0 0 0 0 0 0 0];
k01_41=[0 0 0 0 0 0 0 0 0 0 0];
k1=[k01_10 k01_20 k01_30 k01_41];
%2      1 2 3 4 5 6 7 8 9 10
k02_10=[B(2) A(2) B(2) C(2) 0 0 0 0 0 0];
k02_20=[0 0 0 0 0 0 0 0 0 0];
k02_30=[0 0 0 0 0 0 0 0 0 0];
k02_41=[0 0 0 0 0 0 0 0 0 0 0];
k2=[k02_10 k02_20 k02_30 k02_41];
%3      1 2 3 4 5 6 7 8 9 10
k03_10=[C(3) B(3) A(3) B(3) C(3) 0 0 0 0 0];
k03_20=[0 0 0 0 0 0 0 0 0 0];
k03_30=[0 0 0 0 0 0 0 0 0 0];
k03_41=[0 0 0 0 0 0 0 0 0 0 0];
k3=[k03_10 k03_20 k03_30 k03_41];
%4      1 2 3 4 5 6 7 8 9 10
k04_10=[0 C(4) B(4) A(4) B(4) C(4) 0 0 0 0];
k04_20=[0 0 0 0 0 0 0 0 0 0];
k04_30=[0 0 0 0 0 0 0 0 0 0];
k04_41=[0 0 0 0 0 0 0 0 0 0 0];
k4=[k04_10 k04_20 k04_30 k04_41];
%5      1 2 3 4 5 6 7 8 9 10
k05_10=[0 0 C(5) B(5) A(5) B(5) C(5) 0 0 0];
k05_20=[0 0 0 0 0 0 0 0 0 0];
k05_30=[0 0 0 0 0 0 0 0 0 0];
k05_41=[0 0 0 0 0 0 0 0 0 0 0];
k5=[k05_10 k05_20 k05_30 k05_41];
%6      1 2 3 4 5 6 7 8 9 10
k06_10=[0 0 0 C(6) B(6) A(6) B(6) C(6) 0 0];
k06_20=[0 0 0 0 0 0 0 0 0 0];
k06_30=[0 0 0 0 0 0 0 0 0 0];
k06_41=[0 0 0 0 0 0 0 0 0 0 0];
k6=[k06_10 k06_20 k06_30 k06_41];
%7      1 2 3 4 5 6 7 8 9 10
k07_10=[0 0 0 0 C(7) B(7) A(7) B(7) C(7) 0];
k07_20=[0 0 0 0 0 0 0 0 0 0];
k07_30=[0 0 0 0 0 0 0 0 0 0];
k07_41=[0 0 0 0 0 0 0 0 0 0 0];
k7=[k07_10 k07_20 k07_30 k07_41];
%8      1 2 3 4 5 6 7 8 9 10
k08_10=[0 0 0 0 0 C(8) B(8) A(8) B(8) C(8)];
k08_20=[0 0 0 0 0 0 0 0 0 0];
k08_30=[0 0 0 0 0 0 0 0 0 0];
k08_41=[0 0 0 0 0 0 0 0 0 0 0];
k8=[k08_10 k08_20 k08_30 k08_41];
%9      1 2 3 4 5 6 7 8 9 10
k09_10=[0 0 0 0 0 0 C(9) B(9) A(9) B(9)];
k09_20=[C(9) 0 0 0 0 0 0 0 0 0 0];
k09_30=[0 0 0 0 0 0 0 0 0 0];
k09_41=[0 0 0 0 0 0 0 0 0 0];
k9=[k09_10 k09_20 k09_30 k09_41];
%10      1 2 3 4 5 6 7 8 9 10
k10_10= [0 0 0 0 0 0 0 C(10) B(10) A(10)];
k10_20= [B(10) C(10) 0 0 0 0 0 0 0 0 0];
k10_30= [0 0 0 0 0 0 0 0 0 0];
k10_41= [0 0 0 0 0 0 0 0 0 0];
k10=[k10_10 k10_20 k10_30 k10_41];
%11      1 2 3 4 5 6 7 8 9 10
k11_10= [0 0 0 0 0 0 0 0 C(11) B(11)];
k11_20= [A(11) B(11) C(11) 0 0 0 0 0 0 0];
k11_30= [0 0 0 0 0 0 0 0 0 0];
k11_41= [0 0 0 0 0 0 0 0 0 0 0];
k11=[k11_10 k11_20 k11_30 k11_41];
%12      1 2 3 4 5 6 7 8 9 10
k12_10= [0 0 0 0 0 0 0 0 0 C(12)];
k12_20= [B(12) A(12) B(12) C(12) 0 0 0 0 0 0];
k12_30= [0 0 0 0 0 0 0 0 0 0];
k12_41= [0 0 0 0 0 0 0 0 0 0 0];
k12=[k12_10 k12_20 k12_30 k12_41];
%13      1 2 3 4 5 6 7 8 9 10
k13_10= [0 0 0 0 0 0 0 0 0 0];
k13_20= [C(13) B(13) A(13) B(13) C(13) 0 0 0 0 0];
k13_30= [0 0 0 0 0 0 0 0 0 0];
k13_41= [0 0 0 0 0 0 0 0 0 0 0];
k13=[k13_10 k13_20 k13_30 k13_41];
%14      1 2 3 4 5 6 7 8 9 10
k14_10= [0 0 0 0 0 0 0 0 0 0];
k14_20= [0 C(14) B(14) A(14) B(14) C(14) 0 0 0 0 0];
k14_30= [0 0 0 0 0 0 0 0 0 0];
k14_41= [0 0 0 0 0 0 0 0 0 0];
k14=[k14_10 k14_20 k14_30 k14_41];
%15      1 2 3 4 5 6 7 8 9 10
k15_10= [0 0 0 0 0 0 0 0 0 0];
k15_20= [0 0 C(15) B(15) A(15) B(15) C(15) 0 0 0 0];
k15_30= [0 0 0 0 0 0 0 0 0 0];
k15_41= [0 0 0 0 0 0 0 0 0 0];
k15=[k15_10 k15_20 k15_30 k15_41];
%16      1 2 3 4 5 6 7 8 9 10
k16_10= [0 0 0 0 0 0 0 0 0 0];
k16_20= [0 0 0 C(16) B(16) A(16) B(16) C(16) 0 0 0];
k16_30= [0 0 0 0 0 0 0 0 0 0];
k16_41= [0 0 0 0 0 0 0 0 0 0];
k16=[k16_10 k16_20 k16_30 k16_41];
%17      1 2 3 4 5 6 7 8 9 10
k17_10= [0 0 0 0 0 0 0 0 0 0];
k17_20= [0 0 0 0 C(17) B(17) A(17) B(17) C(17) 0 0];
k17_30= [0 0 0 0 0 0 0 0 0 0];
k17_41= [0 0 0 0 0 0 0 0 0 0];
k17=[k17_10 k17_20 k17_30 k17_41];
%18      1 2 3 4 5 6 7 8 9 10
k18_10= [0 0 0 0 0 0 0 0 0 0];
k18_20= [0 0 0 0 0 C(18) B(18) A(18) B(18) C(18) 0];
k18_30= [0 0 0 0 0 0 0 0 0 0];
k18_41= [0 0 0 0 0 0 0 0 0 0];
k18=[k18_10 k18_20 k18_30 k18_41];
%19      1 2 3 4 5 6 7 8 9 10
k19_10= [0 0 0 0 0 0 0 0 0 0];
k19_20= [0 0 0 0 0 0 C(19) B(19) A(19) B(19) C(19)];
k19_30= [0 0 0 0 0 0 0 0 0 0];
k19_41= [0 0 0 0 0 0 0 0 0 0];
k19=[k19_10 k19_20 k19_30 k19_41];
%20      1 2 3 4 5 6 7 8 9 10
k20_10= [0 0 0 0 0 0 0 0 0 0];
k20_20= [0 0 0 0 0 0 0 C(20) B(20) A(20) B(20)];
k20_30= [C(20) 0 0 0 0 0 0 0 0 0];
k20_41= [0 0 0 0 0 0 0 0 0 0];
k20=[k20_10 k20_20 k20_30 k20_41];
%21      1 2 3 4 5 6 7 8 9 10
k21_10= [0 0 0 0 0 0 0 0 0 0];
k21_20= [0 0 0 0 0 0 0 0 C(21) B(21) A(21)];
k21_30= [B(21) C(21) 0 0 0 0 0 0 0 0];
k21_41= [0 0 0 0 0 0 0 0 0 0];
k21=[k21_10 k21_20 k21_30 k21_41];
%22      1 2 3 4 5 6 7 8 9 10
k22_10= [0 0 0 0 0 0 0 0 0 0];
k22_20= [0 0 0 0 0 0 0 0 0 C(22) B(22)];
k22_30= [A(22) B(22) C(22) 0 0 0 0 0 0 0];
k22_41= [0 0 0 0 0 0 0 0 0 0];
k22=[k22_10 k22_20 k22_30 k22_41];
%23      1 2 3 4 5 6 7 8 9 10
k23_10= [0 0 0 0 0 0 0 0 0 0];
k23_20= [0 0 0 0 0 0 0 0 0 0 C(23)];
k23_30= [B(23) A(23) B(23) C(23) 0 0 0 0 0 0];
k23_41= [0 0 0 0 0 0 0 0 0 0];
k23=[k23_10 k23_20 k23_30 k23_41];
%24      1 2 3 4 5 6 7 8 9 10
k24_10= [0 0 0 0 0 0 0 0 0 0];
k24_20= [0 0 0 0 0 0 0 0 0 0 0];
k24_30= [C(24) B(24) A(24) B(24) C(24) 0 0 0 0 0];
k24_41= [0 0 0 0 0 0 0 0 0 0];
k24=[k24_10 k24_20 k24_30 k24_41];
%25      1 2 3 4 5 6 7 8 9 10
k25_10= [0 0 0 0 0 0 0 0 0 0];
k25_20= [0 0 0 0 0 0 0 0 0 0 0];
k25_30= [0 C(25) B(25) A(25) B(25) C(25) 0 0 0 0];
k25_41= [0 0 0 0 0 0 0 0 0 0];
k25=[k25_10 k25_20 k25_30 k25_41];
%26      1 2 3 4 5 6 7 8 9 10
k26_10= [0 0 0 0 0 0 0 0 0 0];
k26_20= [0 0 0 0 0 0 0 0 0 0 0];
k26_30= [0 0 C(26) B(26) A(26) B(26) C(26) 0 0 0];
k26_41= [0 0 0 0 0 0 0 0 0 0];
k26=[k26_10 k26_20 k26_30 k26_41];
%27      1 2 3 4 5 6 7 8 9 10
k27_10= [0 0 0 0 0 0 0 0 0 0];
k27_20= [0 0 0 0 0 0 0 0 0 0 0];
k27_30= [0 0 0 C(27) B(27) A(27) B(27) C(27) 0 0];
k27_41= [0 0 0 0 0 0 0 0 0 0];
k27=[k27_10 k27_20 k27_30 k27_41];
%28      1 2 3 4 5 6 7 8 9 10
k28_10= [0 0 0 0 0 0 0 0 0 0];
k28_20= [0 0 0 0 0 0 0 0 0 0 0];
k28_30= [0 0 0 0 C(28) B(28) A(28) B(28) C(28) 0];
k28_41= [0 0 0 0 0 0 0 0 0 0];
k28=[k28_10 k28_20 k28_30 k28_41];
%29      1 2 3 4 5 6 7 8 9 10
k29_10= [0 0 0 0 0 0 0 0 0 0];
k29_20= [0 0 0 0 0 0 0 0 0 0 0];
k29_30= [0 0 0 0 0 C(29) B(29) A(29) B(29) C(29)];
k29_41= [0 0 0 0 0 0 0 0 0 0];
k29=[k29_10 k29_20 k29_30 k29_41];
%30      1 2 3 4 5 6 7 8 9 10
k30_10= [0 0 0 0 0 0 0 0 0 0];
k30_20= [0 0 0 0 0 0 0 0 0 0 0];
k30_30= [0 0 0 0 0 0 C(30) B(30) A(30) B(30)];
k30_41= [C(30) 0 0 0 0 0 0 0 0 0];
k30=[k30_10 k30_20 k30_30 k30_41];
%31      1 2 3 4 5 6 7 8 9 10
k31_10= [0 0 0 0 0 0 0 0 0 0];
k31_20= [0 0 0 0 0 0 0 0 0 0 0];
k31_30= [0 0 0 0 0 0 0 C(31) B(31) A(31)];
k31_41= [B(31) C(31) 0 0 0 0 0 0 0 0];
k31=[k31_10 k31_20 k31_30 k31_41];
%32      1 2 3 4 5 6 7 8 9 10
k32_10= [0 0 0 0 0 0 0 0 0 0];
k32_20= [0 0 0 0 0 0 0 0 0 0 0];
k32_30= [0 0 0 0 0 0 0 0 C(32) B(32)];
k32_41= [A(32) B(32) C(32) 0 0 0 0 0 0 0];
k32=[k32_10 k32_20 k32_30 k32_41];
%33      1 2 3 4 5 6 7 8 9 10
k33_10= [0 0 0 0 0 0 0 0 0 0];
k33_20= [0 0 0 0 0 0 0 0 0 0 0];
k33_30= [0 0 0 0 0 0 0 0 0 C(33)];
k33_41= [B(33) A(33) B(33) C(33) 0 0 0 0 0 0];
k33=[k33_10 k33_20 k33_30 k33_41];
%34      1 2 3 4 5 6 7 8 9 10
k34_10= [0 0 0 0 0 0 0 0 0 0];
k34_20= [0 0 0 0 0 0 0 0 0 0 0];
k34_30= [0 0 0 0 0 0 0 0 0 0];
k34_41= [C(34) B(34) A(34) B(34) C(34) 0 0 0 0 0];
k34=[k34_10 k34_20 k34_30 k34_41];
%35      1 2 3 4 5 6 7 8 9 10
k35_10= [0 0 0 0 0 0 0 0 0 0];
k35_20= [0 0 0 0 0 0 0 0 0 0 0];
k35_30= [0 0 0 0 0 0 0 0 0 0];
k35_41= [0 C(35) B(35) A(35) B(35) C(35) 0 0 0 0];
k35=[k35_10 k35_20 k35_30 k35_41];
%36      1 2 3 4 5 6 7 8 9 10
k36_10= [0 0 0 0 0 0 0 0 0 0];
k36_20= [0 0 0 0 0 0 0 0 0 0 0];
k36_30= [0 0 0 0 0 0 0 0 0 0];
k36_41= [0 0 C(36) B(36) A(36) B(36) C(36) 0 0 0];
k36=[k36_10 k36_20 k36_30 k36_41];
%37      1 2 3 4 5 6 7 8 9 10
k37_10= [0 0 0 0 0 0 0 0 0 0];
k37_20= [0 0 0 0 0 0 0 0 0 0 0];
k37_30= [0 0 0 0 0 0 0 0 0 0];
k37_41= [0 0 0 C(37) B(37) A(37) B(37) C(37) 0 0];
k37=[k37_10 k37_20 k37_30 k37_41];
%38      1 2 3 4 5 6 7 8 9 10
k38_10= [0 0 0 0 0 0 0 0 0 0];
k38_20= [0 0 0 0 0 0 0 0 0 0 0];
k38_30= [0 0 0 0 0 0 0 0 0 0];
k38_41= [0 0 0 0 C(38) B(38) A(38) B(38) C(38) 0];
k38=[k38_10 k38_20 k38_30 k38_41];
%39      1 2 3 4 5 6 7 8 9 10
k39_10= [0 0 0 0 0 0 0 0 0 0];
k39_20= [0 0 0 0 0 0 0 0 0 0 0];
k39_30= [0 0 0 0 0 0 0 0 0 0];
k39_41= [0 0 0 0 0 C(39) B(39) A(39) B(39) C(39)];
k39=[k39_10 k39_20 k39_30 k39_41];
%40      1 2 3 4 5 6 7 8 9 10
k40_10= [0 0 0 0 0 0 0 0 0 0];
k40_20= [0 0 0 0 0 0 0 0 0 0 0];
k40_30= [0 0 0 0 0 0 0 0 0 0];
k40_41= [0 0 0 0 0 0 C(40) B(40) A(40) B(40)];
k40=[k40_10 k40_20 k40_30 k40_41];
%41      1 2 3 4 5 6 7 8 9 10
k41_10= [0 0 0 0 0 0 0 0 0 0];
k41_20= [0 0 0 0 0 0 0 0 0 0 0];
k41_30= [0 0 0 0 0 0 0 0 0 0];
k41_41= [0 0 0 0 0 0 0 C(41) B(41) A(41)];
k41=[k41_10 k41_20 k41_30 k41_41];
Kinit=[k1;k2;k3;k4;k5;k6;k7;k8;k9;k10;k11;k12;k13;k14;k15;k16;k17;k18;k19;k20;k21;k22;k23;k24;k25;k26;k27;k28;k29;k30;k31;k32;k33;k34;k35;k36;k37;k38;k39;k40;k41];
% Define the applied load
F=    [.5*Q;Q;Q;Q;Q;
       Q;Q;Q;Q;Q;
       Q;Q;Q;Q;Q;
       Q;Q;Q;Q;Q;
       Q;Q;Q;Q;Q;
       Q;Q;Q;Q;Q;
       Q;Q;Q;Q;Q;
       Q;Q;Q;Q;Q;.5*Q]*I;
it = 0; % initialize iteration count
residual = 100; % initialize residual
% calculate Force
while (residual > tolerance)
   z= [-2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(1)
       1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(2)
       0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(3)
       0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(4)
       0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(5)
       0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(6)
       0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(7)
       0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(8)
       0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(9)
       0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(10)
       0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(11)
       0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(12)
       0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(13)
       0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(14)
       0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(15)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(16)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(17)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(18)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(19)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(20)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(21)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(22)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(23)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(24)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(25)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(26)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0 0; % section(27)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0 0; % section(28)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0 0; % section(29)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0 0; % section(30)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0 0; % section(31)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0 0; % section(32)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0 0; % section(33)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0 0; % section(34)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0 0; % section(35)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0 0; % section(36)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0 0; % section(37)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0 0; % section(38)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1 0; % section(39)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2 1; % section(40)
       0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 -2]; % section(41)
   fi = (z/landa^2)*u; % Curvature of each section
   for i=1:41;
     if and(abs(fi(i)) >=0,abs(fi(i)) <=da(i,1));
         EI(i) = EIe(i);
     elseif and(abs(fi(i)) >da(i,1),abs(fi(i)) <=da(i,3));
         EI(i) =(da(i,2) +(abs(fi(i))-da(i,1))*EIp(i))/abs(fi(i));
     end
     Mi(i)=EI(i)*fi(i);% Moment at each section
     a(i)=EI(i)/(landa^4);
   end
   % Finite-difference coefficients
   A(1)=2*6*a(1);B(1)=-4*a(1);C(1)=a(1);A(41)=2*6*a(41);B(41)=-4*a(41);C(41)=a(41);
   for j=2:1:40;A(j)=6*a(j);B(j)=-4*a(j);C(j)=a(j);end
       
% Equivalent stiffness Matrix
%1      1 2 3 4 5 6 7 8 9 10
k01_10=[A(1) B(1) C(1) 0 0 0 0 0 0 0];
k01_20=[0 0 0 0 0 0 0 0 0 0];
k01_30=[0 0 0 0 0 0 0 0 0 0];
k01_41=[0 0 0 0 0 0 0 0 0 0 0];
k1=[k01_10 k01_20 k01_30 k01_41];
%2      1 2 3 4 5 6 7 8 9 10
k02_10=[B(2) A(2) B(2) C(2) 0 0 0 0 0 0];
k02_20=[0 0 0 0 0 0 0 0 0 0];
k02_30=[0 0 0 0 0 0 0 0 0 0];
k02_41=[0 0 0 0 0 0 0 0 0 0 0];
k2=[k02_10 k02_20 k02_30 k02_41];
%3      1 2 3 4 5 6 7 8 9 10
k03_10=[C(3) B(3) A(3) B(3) C(3) 0 0 0 0 0];
k03_20=[0 0 0 0 0 0 0 0 0 0];
k03_30=[0 0 0 0 0 0 0 0 0 0];
k03_41=[0 0 0 0 0 0 0 0 0 0 0];
k3=[k03_10 k03_20 k03_30 k03_41];
%4      1 2 3 4 5 6 7 8 9 10
k04_10=[0 C(4) B(4) A(4) B(4) C(4) 0 0 0 0];
k04_20=[0 0 0 0 0 0 0 0 0 0];
k04_30=[0 0 0 0 0 0 0 0 0 0];
k04_41=[0 0 0 0 0 0 0 0 0 0 0];
k4=[k04_10 k04_20 k04_30 k04_41];
%5      1 2 3 4 5 6 7 8 9 10
k05_10=[0 0 C(5) B(5) A(5) B(5) C(5) 0 0 0];
k05_20=[0 0 0 0 0 0 0 0 0 0];
k05_30=[0 0 0 0 0 0 0 0 0 0];
k05_41=[0 0 0 0 0 0 0 0 0 0 0];
k5=[k05_10 k05_20 k05_30 k05_41];
%6      1 2 3 4 5 6 7 8 9 10
k06_10=[0 0 0 C(6) B(6) A(6) B(6) C(6) 0 0];
k06_20=[0 0 0 0 0 0 0 0 0 0];
k06_30=[0 0 0 0 0 0 0 0 0 0];
k06_41=[0 0 0 0 0 0 0 0 0 0 0];
k6=[k06_10 k06_20 k06_30 k06_41];
%7      1 2 3 4 5 6 7 8 9 10
k07_10=[0 0 0 0 C(7) B(7) A(7) B(7) C(7) 0];
k07_20=[0 0 0 0 0 0 0 0 0 0];
k07_30=[0 0 0 0 0 0 0 0 0 0];
k07_41=[0 0 0 0 0 0 0 0 0 0 0];
k7=[k07_10 k07_20 k07_30 k07_41];
%8      1 2 3 4 5 6 7 8 9 10
k08_10=[0 0 0 0 0 C(8) B(8) A(8) B(8) C(8)];
k08_20=[0 0 0 0 0 0 0 0 0 0];
k08_30=[0 0 0 0 0 0 0 0 0 0];
k08_41=[0 0 0 0 0 0 0 0 0 0 0];
k8=[k08_10 k08_20 k08_30 k08_41];
%9      1 2 3 4 5 6 7 8 9 10
k09_10=[0 0 0 0 0 0 C(9) B(9) A(9) B(9)];
k09_20=[C(9) 0 0 0 0 0 0 0 0 0 0];
k09_30=[0 0 0 0 0 0 0 0 0 0];
k09_41=[0 0 0 0 0 0 0 0 0 0];
k9=[k09_10 k09_20 k09_30 k09_41];
%10      1 2 3 4 5 6 7 8 9 10
k10_10= [0 0 0 0 0 0 0 C(10) B(10) A(10)];
k10_20= [B(10) C(10) 0 0 0 0 0 0 0 0 0];
k10_30= [0 0 0 0 0 0 0 0 0 0];
k10_41= [0 0 0 0 0 0 0 0 0 0];
k10=[k10_10 k10_20 k10_30 k10_41];
%11      1 2 3 4 5 6 7 8 9 10
k11_10= [0 0 0 0 0 0 0 0 C(11) B(11)];
k11_20= [A(11) B(11) C(11) 0 0 0 0 0 0 0];
k11_30= [0 0 0 0 0 0 0 0 0 0];
k11_41= [0 0 0 0 0 0 0 0 0 0 0];
k11=[k11_10 k11_20 k11_30 k11_41];
%12      1 2 3 4 5 6 7 8 9 10
k12_10= [0 0 0 0 0 0 0 0 0 C(12)];
k12_20= [B(12) A(12) B(12) C(12) 0 0 0 0 0 0];
k12_30= [0 0 0 0 0 0 0 0 0 0];
k12_41= [0 0 0 0 0 0 0 0 0 0 0];
k12=[k12_10 k12_20 k12_30 k12_41];
%13      1 2 3 4 5 6 7 8 9 10
k13_10= [0 0 0 0 0 0 0 0 0 0];
k13_20= [C(13) B(13) A(13) B(13) C(13) 0 0 0 0 0];
k13_30= [0 0 0 0 0 0 0 0 0 0];
k13_41= [0 0 0 0 0 0 0 0 0 0 0];
k13=[k13_10 k13_20 k13_30 k13_41];
%14      1 2 3 4 5 6 7 8 9 10
k14_10= [0 0 0 0 0 0 0 0 0 0];
k14_20= [0 C(14) B(14) A(14) B(14) C(14) 0 0 0 0 0];
k14_30= [0 0 0 0 0 0 0 0 0 0];
k14_41= [0 0 0 0 0 0 0 0 0 0];
k14=[k14_10 k14_20 k14_30 k14_41];
%15      1 2 3 4 5 6 7 8 9 10
k15_10= [0 0 0 0 0 0 0 0 0 0];
k15_20= [0 0 C(15) B(15) A(15) B(15) C(15) 0 0 0 0];
k15_30= [0 0 0 0 0 0 0 0 0 0];
k15_41= [0 0 0 0 0 0 0 0 0 0];
k15=[k15_10 k15_20 k15_30 k15_41];
%16      1 2 3 4 5 6 7 8 9 10
k16_10= [0 0 0 0 0 0 0 0 0 0];
k16_20= [0 0 0 C(16) B(16) A(16) B(16) C(16) 0 0 0];
k16_30= [0 0 0 0 0 0 0 0 0 0];
k16_41= [0 0 0 0 0 0 0 0 0 0];
k16=[k16_10 k16_20 k16_30 k16_41];
%17      1 2 3 4 5 6 7 8 9 10
k17_10= [0 0 0 0 0 0 0 0 0 0];
k17_20= [0 0 0 0 C(17) B(17) A(17) B(17) C(17) 0 0];
k17_30= [0 0 0 0 0 0 0 0 0 0];
k17_41= [0 0 0 0 0 0 0 0 0 0];
k17=[k17_10 k17_20 k17_30 k17_41];
%18      1 2 3 4 5 6 7 8 9 10
k18_10= [0 0 0 0 0 0 0 0 0 0];
k18_20= [0 0 0 0 0 C(18) B(18) A(18) B(18) C(18) 0];
k18_30= [0 0 0 0 0 0 0 0 0 0];
k18_41= [0 0 0 0 0 0 0 0 0 0];
k18=[k18_10 k18_20 k18_30 k18_41];
%19      1 2 3 4 5 6 7 8 9 10
k19_10= [0 0 0 0 0 0 0 0 0 0];
k19_20= [0 0 0 0 0 0 C(19) B(19) A(19) B(19) C(19)];
k19_30= [0 0 0 0 0 0 0 0 0 0];
k19_41= [0 0 0 0 0 0 0 0 0 0];
k19=[k19_10 k19_20 k19_30 k19_41];
%20      1 2 3 4 5 6 7 8 9 10
k20_10= [0 0 0 0 0 0 0 0 0 0];
k20_20= [0 0 0 0 0 0 0 C(20) B(20) A(20) B(20)];
k20_30= [C(20) 0 0 0 0 0 0 0 0 0];
k20_41= [0 0 0 0 0 0 0 0 0 0];
k20=[k20_10 k20_20 k20_30 k20_41];
%21      1 2 3 4 5 6 7 8 9 10
k21_10= [0 0 0 0 0 0 0 0 0 0];
k21_20= [0 0 0 0 0 0 0 0 C(21) B(21) A(21)];
k21_30= [B(21) C(21) 0 0 0 0 0 0 0 0];
k21_41= [0 0 0 0 0 0 0 0 0 0];
k21=[k21_10 k21_20 k21_30 k21_41];
%22      1 2 3 4 5 6 7 8 9 10
k22_10= [0 0 0 0 0 0 0 0 0 0];
k22_20= [0 0 0 0 0 0 0 0 0 C(22) B(22)];
k22_30= [A(22) B(22) C(22) 0 0 0 0 0 0 0];
k22_41= [0 0 0 0 0 0 0 0 0 0];
k22=[k22_10 k22_20 k22_30 k22_41];
%23      1 2 3 4 5 6 7 8 9 10
k23_10= [0 0 0 0 0 0 0 0 0 0];
k23_20= [0 0 0 0 0 0 0 0 0 0 C(23)];
k23_30= [B(23) A(23) B(23) C(23) 0 0 0 0 0 0];
k23_41= [0 0 0 0 0 0 0 0 0 0];
k23=[k23_10 k23_20 k23_30 k23_41];
%24      1 2 3 4 5 6 7 8 9 10
k24_10= [0 0 0 0 0 0 0 0 0 0];
k24_20= [0 0 0 0 0 0 0 0 0 0 0];
k24_30= [C(24) B(24) A(24) B(24) C(24) 0 0 0 0 0];
k24_41= [0 0 0 0 0 0 0 0 0 0];
k24=[k24_10 k24_20 k24_30 k24_41];
%25      1 2 3 4 5 6 7 8 9 10
k25_10= [0 0 0 0 0 0 0 0 0 0];
k25_20= [0 0 0 0 0 0 0 0 0 0 0];
k25_30= [0 C(25) B(25) A(25) B(25) C(25) 0 0 0 0];
k25_41= [0 0 0 0 0 0 0 0 0 0];
k25=[k25_10 k25_20 k25_30 k25_41];
%26      1 2 3 4 5 6 7 8 9 10
k26_10= [0 0 0 0 0 0 0 0 0 0];
k26_20= [0 0 0 0 0 0 0 0 0 0 0];
k26_30= [0 0 C(26) B(26) A(26) B(26) C(26) 0 0 0];
k26_41= [0 0 0 0 0 0 0 0 0 0];
k26=[k26_10 k26_20 k26_30 k26_41];
%27      1 2 3 4 5 6 7 8 9 10
k27_10= [0 0 0 0 0 0 0 0 0 0];
k27_20= [0 0 0 0 0 0 0 0 0 0 0];
k27_30= [0 0 0 C(27) B(27) A(27) B(27) C(27) 0 0];
k27_41= [0 0 0 0 0 0 0 0 0 0];
k27=[k27_10 k27_20 k27_30 k27_41];
%28      1 2 3 4 5 6 7 8 9 10
k28_10= [0 0 0 0 0 0 0 0 0 0];
k28_20= [0 0 0 0 0 0 0 0 0 0 0];
k28_30= [0 0 0 0 C(28) B(28) A(28) B(28) C(28) 0];
k28_41= [0 0 0 0 0 0 0 0 0 0];
k28=[k28_10 k28_20 k28_30 k28_41];
%29      1 2 3 4 5 6 7 8 9 10
k29_10= [0 0 0 0 0 0 0 0 0 0];
k29_20= [0 0 0 0 0 0 0 0 0 0 0];
k29_30= [0 0 0 0 0 C(29) B(29) A(29) B(29) C(29)];
k29_41= [0 0 0 0 0 0 0 0 0 0];
k29=[k29_10 k29_20 k29_30 k29_41];
%30      1 2 3 4 5 6 7 8 9 10
k30_10= [0 0 0 0 0 0 0 0 0 0];
k30_20= [0 0 0 0 0 0 0 0 0 0 0];
k30_30= [0 0 0 0 0 0 C(30) B(30) A(30) B(30)];
k30_41= [C(30) 0 0 0 0 0 0 0 0 0];
k30=[k30_10 k30_20 k30_30 k30_41];
%31      1 2 3 4 5 6 7 8 9 10
k31_10= [0 0 0 0 0 0 0 0 0 0];
k31_20= [0 0 0 0 0 0 0 0 0 0 0];
k31_30= [0 0 0 0 0 0 0 C(31) B(31) A(31)];
k31_41= [B(31) C(31) 0 0 0 0 0 0 0 0];
k31=[k31_10 k31_20 k31_30 k31_41];
%32      1 2 3 4 5 6 7 8 9 10
k32_10= [0 0 0 0 0 0 0 0 0 0];
k32_20= [0 0 0 0 0 0 0 0 0 0 0];
k32_30= [0 0 0 0 0 0 0 0 C(32) B(32)];
k32_41= [A(32) B(32) C(32) 0 0 0 0 0 0 0];
k32=[k32_10 k32_20 k32_30 k32_41];
%33      1 2 3 4 5 6 7 8 9 10
k33_10= [0 0 0 0 0 0 0 0 0 0];
k33_20= [0 0 0 0 0 0 0 0 0 0 0];
k33_30= [0 0 0 0 0 0 0 0 0 C(33)];
k33_41= [B(33) A(33) B(33) C(33) 0 0 0 0 0 0];
k33=[k33_10 k33_20 k33_30 k33_41];
%34      1 2 3 4 5 6 7 8 9 10
k34_10= [0 0 0 0 0 0 0 0 0 0];
k34_20= [0 0 0 0 0 0 0 0 0 0 0];
k34_30= [0 0 0 0 0 0 0 0 0 0];
k34_41= [C(34) B(34) A(34) B(34) C(34) 0 0 0 0 0];
k34=[k34_10 k34_20 k34_30 k34_41];
%35      1 2 3 4 5 6 7 8 9 10
k35_10= [0 0 0 0 0 0 0 0 0 0];
k35_20= [0 0 0 0 0 0 0 0 0 0 0];
k35_30= [0 0 0 0 0 0 0 0 0 0];
k35_41= [0 C(35) B(35) A(35) B(35) C(35) 0 0 0 0];
k35=[k35_10 k35_20 k35_30 k35_41];
%36      1 2 3 4 5 6 7 8 9 10
k36_10= [0 0 0 0 0 0 0 0 0 0];
k36_20= [0 0 0 0 0 0 0 0 0 0 0];
k36_30= [0 0 0 0 0 0 0 0 0 0];
k36_41= [0 0 C(36) B(36) A(36) B(36) C(36) 0 0 0];
k36=[k36_10 k36_20 k36_30 k36_41];
%37      1 2 3 4 5 6 7 8 9 10
k37_10= [0 0 0 0 0 0 0 0 0 0];
k37_20= [0 0 0 0 0 0 0 0 0 0 0];
k37_30= [0 0 0 0 0 0 0 0 0 0];
k37_41= [0 0 0 C(37) B(37) A(37) B(37) C(37) 0 0];
k37=[k37_10 k37_20 k37_30 k37_41];
%38      1 2 3 4 5 6 7 8 9 10
k38_10= [0 0 0 0 0 0 0 0 0 0];
k38_20= [0 0 0 0 0 0 0 0 0 0 0];
k38_30= [0 0 0 0 0 0 0 0 0 0];
k38_41= [0 0 0 0 C(38) B(38) A(38) B(38) C(38) 0];
k38=[k38_10 k38_20 k38_30 k38_41];
%39      1 2 3 4 5 6 7 8 9 10
k39_10= [0 0 0 0 0 0 0 0 0 0];
k39_20= [0 0 0 0 0 0 0 0 0 0 0];
k39_30= [0 0 0 0 0 0 0 0 0 0];
k39_41= [0 0 0 0 0 C(39) B(39) A(39) B(39) C(39)];
k39=[k39_10 k39_20 k39_30 k39_41];
%40      1 2 3 4 5 6 7 8 9 10
k40_10= [0 0 0 0 0 0 0 0 0 0];
k40_20= [0 0 0 0 0 0 0 0 0 0 0];
k40_30= [0 0 0 0 0 0 0 0 0 0];
k40_41= [0 0 0 0 0 0 C(40) B(40) A(40) B(40)];
k40=[k40_10 k40_20 k40_30 k40_41];
%41      1 2 3 4 5 6 7 8 9 10
k41_10= [0 0 0 0 0 0 0 0 0 0];
k41_20= [0 0 0 0 0 0 0 0 0 0 0];
k41_30= [0 0 0 0 0 0 0 0 0 0];
k41_41= [0 0 0 0 0 0 0 C(41) B(41) A(41)];
k41=[k41_10 k41_20 k41_30 k41_41];
K=[k1;k2;k3;k4;k5;k6;k7;k8;k9;k10;k11;k12;k13;k14;k15;k16;k17;k18;k19;k20;k21;k22;k23;k24;k25;k26;k27;k28;k29;k30;k31;k32;k33;k34;k35;k36;k37;k38;k39;k40;k41];
f=F-K*u;
        %calculate du
        du = Kinit^-1 *(f);
        u = u+du; % update u
        %Calculate the residual (internal-external force deviation)
        residual = max(abs(du)); % evaluate residual
        it = it + 1; % increment iteration count
        if it == itermax
          fprintf('(-)For increment %1.0f trail iteration reached to Ultimate %1.0f\n',I,it)
             disp('    ## The solution for this step is not converged ##')
             break
        end
end
for s=1:1:41;M(:,I)=Mi;end;
DU1(I)=residual;I1(I)=I;IT1(I)=it;
U(:,I)=[0;u;0];Phi(:,I)=fi;Uz(I)=u(21);EIz(:,I)=roundn(EI,-1);
FF(I)=max(F);
if it < itermax
   fprintf('(+)It is converged in %1.0f iterations for increment %1.0f\n',it,I)
end
   % Curvature control
           if abs(fi(1)) >= da(1,3)
           disp('      ## Curvature at first node of element reached to Ultimate Curvature ##')
           %break
           end
           if abs(fi(11)) >= da(21,3)
           disp('      ## Curvature at middle reached to Ultimate Curvature ##')
           break
           end
           if abs(fi(21)) >= da(41,3)
           disp('      ## Curvature at last node of element reached to Ultimate Curvature ##')
           %break
           end
           % Displacement control
           if max(abs(u)) >= Dmax
           disp('      ## Displacement at Middle node of element reached to Ultimate Displacement ##')
           break
           end
end
landa=L/42;for i=1:1:41;Xf(i)=landa+(i-1)*landa;end % Length of Calculated data
% Structural Lateral Stiffness [DOF(11)]
s=size(Uz,2);for i=1:s-1;Kz1(i)=(FF(i))/(Uz(i));Uzz(i)=Uz(i+1);end
%% Moment-Curvature of each section Ploting
for i=1:1:41;
for j=1:100;
    Uc=da(i,3)/100;uc(j)=Uc*j;
     if and(abs(uc(j)) >=0,abs(uc(j)) <=da(i,1));
         EI(i) = EIe(i);
     elseif and(abs(uc(j)) >da(i,1),abs(uc(j)) <=da(i,3));
         EIpi(i)=(da(i,4)-da(i,2))/(da(i,3)-da(i,1));
         EI(i) =(da(i,2) +(abs(uc(j))-da(i,1))*EIpi(i))/abs(uc(j));
     end
     Hc(j)=EI(i)*uc(j);% Moment at each section
end
CC(:,i)=uc;% Curvature of each section
MM(:,i)=Hc;% Moment of each section
end
%% Ploting
figure(1)
IMAGE=imread('NonlinearAnalBeamFiniteDifferenceMomentCurvatureFC41nodes-image1.jpg');
image(IMAGE);axis image;axis off;
figure(2)
IMAGE=imread('NonlinearAnalBeamFiniteDifferenceMomentCurvatureFC41nodes-image2.jpg');
image(IMAGE);axis image;axis off;
figure(3)
p1=plot(I1,DU1,'black');grid on;set(p1,'LineWidth',2);
xlabel('increment');ylabel('Residual');
title('Residual-increment diagram','color','b');
figure(4)
p1=plot(I1,IT1,'black');grid on;set(p1,'LineWidth',2);
xlabel('increment');ylabel('Iteration');
title('Iteration-increment diagram','color','b');
figure(5)
p1=plot(CC,MM);grid on;set(p1,'LineWidth',3);
xlabel('Curvature (1/mm)');ylabel('Moment (kN.mm)');
title('Moment-Curvature Relation','color','b')
figure(6)
P1=plot(Uz,-FF);
xlabel('Displacement (mm) [DOF (21)]');ylabel('Base Shear (kN)');set(P1,'LineWidth',3);grid on;
title('Base Shear-Displacement Diagram','FontSize',12,'color','b');
figure(7)
p1=plot(Uzz,Kz1,'black');grid on;set(p1,'LineWidth',3);
xlabel('Displacement (mm) [DOF (21)]');ylabel('Structural Lateral Stiffness (kN/mm) [DOF (21)]');
title('Structural Lateral Stiffness-Displacement diagram','color','b')
figure(8)
P1=plot(Xf,Phi(:,I/4),Xf,Phi(:,I/2),Xf,Phi(:,3*I/4),Xf,Phi(:,I),'--');
legend('1/4 steps','1/2 steps','3/4 steps','Last step','Location','NorthEastOutside')
xlabel('L (mm)');ylabel('Curvature (1/mm)');set(P1,'LineWidth',3);grid on;
title('Last Step Curvature Diagram','FontSize',12,'color','b');
figure(9)
P1=plot(Xf,EIe,'--',Xf,EIz(:,I/4),Xf,EIz(:,I/2),Xf,EIz(:,3*I/4),Xf,EIp,'-.');
xlabel('L (mm)');ylabel('Flextural Rigidity(EI) (kN.mm^2)');set(P1,'LineWidth',2);grid on;
title('Flextural Rigidity(EI) Diagram','FontSize',12,'color','b');
legend('Full elastic','1/4 steps','1/2 steps','3/4 steps','Full plastic','Location','NorthEastOutside')
figure(10)
P1=plot(Xf,M(:,I/4),Xf,M(:,I/2),Xf,M(:,3*I/4),Xf,M(:,I),'--');
legend('1/4 steps','1/2 steps','3/4 steps','Last step','Location','NorthEastOutside')
xlabel('L (mm)');ylabel('Moment (kN.mm)');set(P1,'LineWidth',3);grid on;
title('Last Step Moment Diagram','FontSize',12,'color','b');
figure(11)
P1=plot(X,U(:,I/4),X,U(:,I/2),X,U(:,3*I/4),X,U(:,I),'--');
legend('1/4 steps','1/2 steps','3/4 steps','Last step','Location','NorthEastOutside')
xlabel('L (mm)');ylabel('Uy (mm)');set(P1,'LineWidth',3);grid on;
title(['Last Step Displacement Diagram',' - Max Finite Difference Disp. (mm) = ',num2str(roundn(max(abs(u)),-2))],'FontSize',12,'color','b');
%% -------------------------------------------------------------------
disp('******************* Result *********************');
%%%  print time of computation
totaltime = cputime - starttime;
fprintf('\nMax Finite Difference Displacement (mm)= %7.4f \n\n',roundn(max(abs(u)),-2))
fprintf('\nTotal time (s)= %7.4f \n\n',totaltime)
disp('************************************************');
